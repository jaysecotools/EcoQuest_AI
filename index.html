<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoQuest: Tasmania Conservation</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .btn-hover {
            transition: all 0.3s ease;
        }
        .btn-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .story-text {
            line-height: 1.6;
        }
        .health-bar {
            transition: width 0.5s ease-in-out;
        }
        .wildlife-item {
            transition: all 0.3s ease;
        }
        .wildlife-item:hover {
            transform: scale(1.05);
        }
        .seasonal-bg {
            background: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 25%, #ffd3b6 50%, #ffaaa5 75%, #ff8b94 100%);
            background-size: 400% 400%;
            animation: gradientShift 30s ease infinite;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .typewriter {
            overflow: hidden;
            border-right: .15em solid green;
            white-space: nowrap;
            margin: 0 auto;
            letter-spacing: .15em;
            animation: typing 3.5s steps(40, end), blink-caret .75s step-end infinite;
        }
        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }
        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: green; }
        }
        #map {
            height: 300px;
            width: 100%;
            border-radius: 0.5rem;
            z-index: 1;
        }
        .multiplayer-chat {
            height: 200px;
            overflow-y: auto;
        }
        .policy-card {
            transition: all 0.3s ease;
        }
        .policy-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .climate-event {
            animation: climatePulse 3s ease;
        }
        @keyframes climatePulse {
            0% { background-color: rgba(239, 68, 68, 0.1); }
            100% { background-color: transparent; }
        }
        .npc-portrait {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .tasmania-bg {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23e0f2e9" opacity="0.3"/><path d="M20,30 Q40,20 60,30 T100,40 L90,70 Q70,90 40,80 T10,60 Z" fill="%23a8e6cf" opacity="0.5"/></svg>');
            background-size: cover;
        }
    </style>
</head>
<body class="seasonal-bg tasmania-bg min-h-screen">
    <div id="root" class="min-h-screen"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Tasmania-specific wildlife and locations
        const tasmaniaWildlife = {
            tassie_devil: { name: "Tasmanian Devil", rarity: "endangered", habitat: "forest", indicator: "forest health", image: "ü¶ò" },
            wedge_eagle: { name: "Wedge-tailed Eagle", rarity: "vulnerable", habitat: "varied", indicator: "ecosystem health", image: "ü¶Ö" },
            platypus: { name: "Platypus", rarity: "rare", habitat: "riparian", indicator: "water quality", image: "ü¶Ü" },
            quoll: { name: "Eastern Quoll", rarity: "endangered", habitat: "forest", indicator: "habitat quality", image: "üêæ" },
            rosella: { name: "Green Rosella", rarity: "common", habitat: "forest", indicator: "forest health", image: "üê¶" },
            pademelon: { name: "Tasmanian Pademelon", rarity: "common", habitat: "forest", indicator: "understory health", image: "ü¶ò" },
            wombat: { name: "Common Wombat", rarity: "common", habitat: "forest", indicator: "soil health", image: "üêª" },
            black_currawong: { name: "Black Currawong", rarity: "common", habitat: "forest", indicator: "forest health", image: "üê¶" },
            freshwater_lobster: { name: "Tasmanian Giant Freshwater Lobster", rarity: "endangered", habitat: "riparian", indicator: "water quality", image: "ü¶û" },
            blue_gum: { name: "Tasmanian Blue Gum", rarity: "common", habitat: "forest", indicator: "forest maturity", image: "üå≥" }
        };

        // Enhanced ecosystem data with more metrics
        const initialEcosystemData = {
            shrubsPlanted: 0,
            treesPlanted: 0,
            wildlifeObserved: [],
            invasiveSpeciesRemoved: 0,
            ecosystemHealth: 50,
            biodiversityIndex: 30,
            carbonSequestration: 0,
            waterQuality: 40,
            locationsVisited: ['tarkine_forest'],
            season: 'spring',
            day: 1,
            budget: 1000,
            reputation: 50,
            educationLevel: 0,
            volunteers: 0,
            historicalData: [{day: 1, health: 50, biodiversity: 30, waterQuality: 40}],
            temperature: 12, // Tasmania is cooler
            rainfall: 80, // Tasmania has higher rainfall
            co2Level: 410, // ppm
            policiesEnacted: [],
            climateEvents: [],
            gameMode: 'solo', // 'solo' or 'team'
            npcTeam: [],
            chatMessages: []
        };

        // Expanded story elements with Tasmania focus
        const initialStoryLog = [
            "üåø Welcome to EcoQuest: Tasmania! Your mission is to restore balance to Tasmania's unique ecosystems.",
            "You arrive in the Tarkine rainforest, one of the last temperate rainforests in the world with ancient myrtle trees and lush ferns."
        ];

        // More diverse initial choices
        const initialChoices = [
            { id: "plant_shrubs", text: "Plant native shrubs", cost: 50, time: 1 },
            { id: "remove_weeds", text: "Remove invasive species", cost: 20, time: 1 },
            { id: "observe_wildlife", text: "Observe wildlife", cost: 0, time: 1 },
            { id: "explore", text: "Explore nearby areas", cost: 0, time: 1 }
        ];

        // Tasmania-specific locations
        const locations = {
            tarkine_forest: {
                name: "Tarkine Rainforest",
                description: "A vast temperate rainforest with ancient myrtle trees, lush ferns, and pristine rivers.",
                restorationPotential: "Very High",
                keySpecies: ["tassie_devil", "quoll", "platypus", "blue_gum"],
                threats: ["logging", "climate change", "invasive species"],
                coordinates: [-41.2, 145.0], // Tarkine region
                biome: "temperate_rainforest"
            },
            cradle_mountain: {
                name: "Cradle Mountain-Lake St Clair",
                description: "An alpine area with rugged mountains, glacial lakes, and diverse alpine vegetation.",
                restorationPotential: "High",
                keySpecies: ["wombat", "pademelon", "wedge_eagle", "black_currawong"],
                threats: ["climate change", "tourist impact", "feral animals"],
                coordinates: [-41.65, 145.95], // Cradle Mountain
                biome: "alpine"
            },
            freycinet: {
                name: "Freycinet Peninsula",
                description: "Coastal heathland with pink granite mountains, white sandy beaches, and abundant birdlife.",
                restorationPotential: "Medium",
                keySpecies: ["rosella", "wedge_eagle", "freshwater_lobster"],
                threats: ["coastal erosion", "tourist impact", "development"],
                coordinates: [-42.13, 148.3], // Freycinet
                biome: "coastal"
            },
            maria_island: {
                name: "Maria Island",
                description: "A island sanctuary with convict history, diverse ecosystems, and reintroduced wildlife.",
                restorationPotential: "High",
                keySpecies: ["tassie_devil", "wombat", "pademelon", "rosella"],
                threats: ["invasive species", "erosion", "climate change"],
                coordinates: [-42.63, 148.0], // Maria Island
                biome: "island"
            },
            macquarie_harbor: {
                name: "Macquarie Harbor",
                description: "A large harbor with salmon farms, historical sites, and important wetland habitats.",
                restorationPotential: "Medium",
                keySpecies: ["platypus", "freshwater_lobster", "black_currawong"],
                threats: ["aquaculture", "pollution", "water quality"],
                coordinates: [-42.3, 145.3], // Macquarie Harbor
                biome: "wetland"
            }
        };

        // NPC team members
        const npcTeamMembers = [
            { id: "botanist", name: "Dr. Lily Chen", role: "Botanist", skills: ["plant_id", "restoration"], efficiency: 1.5, cost: 200, portrait: "üë©‚Äçüî¨" },
            { id: "ecologist", name: "David Wilson", role: "Ecologist", skills: ["wildlife", "monitoring"], efficiency: 1.3, cost: 180, portrait: "üë®‚Äçüî¨" },
            { id: "ranger", name: "Sarah Jones", role: "Park Ranger", skills: ["management", "community"], efficiency: 1.2, cost: 150, portrait: "üë©‚Äçüíº" },
            { id: "indigenous", name: "Michael Brown", role: "Indigenous Guide", skills: ["traditional_knowledge", "tracking"], efficiency: 1.4, cost: 170, portrait: "üë®‚Äçüéì" }
        ];

        // Policy options with costs and effects
        const policyOptions = [
            { id: "carbon_tax", name: "Carbon Tax", cost: 500, effect: "Reduces CO2 levels but may impact budget", co2Impact: -20, budgetImpact: -100, reputationImpact: 10 },
            { id: "renewable_incentives", name: "Renewable Energy Incentives", cost: 800, effect: "Lowers carbon footprint over time", co2Impact: -30, budgetImpact: -200, reputationImpact: 15 },
            { id: "conservation_funding", name: "Conservation Funding", cost: 1000, effect: "Increases ecosystem health metrics", healthImpact: 15, biodiversityImpact: 10, budgetImpact: -300, reputationImpact: 20 },
            { id: "education_reform", name: "Environmental Education", cost: 600, effect: "Raises public awareness and support", educationImpact: 25, reputationImpact: 15, volunteerImpact: 5 },
            { id: "water_regulations", name: "Water Quality Regulations", cost: 700, effect: "Improves water quality but may face opposition", waterQualityImpact: 20, reputationImpact: 5, budgetImpact: -250 },
            { id: "habitat_protection", name: "Habitat Protection Law", cost: 1200, effect: "Preserves critical habitats from development", healthImpact: 20, biodiversityImpact: 25, budgetImpact: -400, reputationImpact: 25 }
        ];

        // Climate events that can occur
        const climateEvents = [
            { id: "drought", name: "Drought", severity: "high", effect: "Reduces water availability and stresses ecosystems", healthImpact: -15, waterQualityImpact: -20, temperatureImpact: 3 },
            { id: "heatwave", name: "Heat Wave", severity: "medium", effect: "Increases temperature and evaporation", healthImpact: -10, temperatureImpact: 5 },
            { id: "flood", name: "Flood", severity: "medium", effect: "Causes erosion but can distribute nutrients", healthImpact: -5, waterQualityImpact: -15, biodiversityImpact: 5 },
            { id: "wildfire", name: "Wildfire", severity: "high", effect: "Destroys habitat but can renew ecosystems long-term", healthImpact: -30, biodiversityImpact: -20, temperatureImpact: 2 },
            { id: "storm", name: "Severe Storm", severity: "medium", effect: "Causes physical damage to restoration projects", healthImpact: -10, budgetImpact: -200 }
        ];

        // AI model simulation with more sophisticated responses
        const generateAIResponse = (choice, ecosystemData, location) => {
            const { ecosystemHealth, biodiversityIndex, waterQuality, season, temperature, co2Level } = ecosystemData;
            
            const responses = {
                "plant_shrubs": [
                    `You plant native Tasmanian shrubs. ${season === 'spring' ? 'The spring rains will help them establish quickly.' : ''}`,
                    "Native shrubs take root, providing habitat for small animals and insects.",
                    "The newly planted shrubs help reduce erosion along the water's edge."
                ],
                "remove_weeds": [
                    `You remove invasive species. ${waterQuality < 50 ? 'You notice the water looks clearer already.' : ''}`,
                    "Manual weeding is slow but effective. You clear a small area of invasive species.",
                    "Removing weeds reduces competition for water and nutrients."
                ],
                "observe_wildlife": [
                    `You spot ${ecosystemHealth > 60 ? 'increased wildlife activity' : 'signs of struggling wildlife'}.`,
                    `${season === 'spring' ? 'Spring brings new life to the area.' : ''} You notice animal tracks and feeding signs.`,
                    "Careful observation reveals how species are interacting with the habitat."
                ],
                "explore": [
                    `You explore the area. ${biodiversityIndex > 40 ? 'The biodiversity seems richer here.' : ''}`,
                    "Exploring reveals connections between different parts of the ecosystem.",
                    "You find a area that would benefit from restoration efforts."
                ],
                "plant_trees": [
                    "You plant native trees. Their roots will stabilize the soil and provide shade.",
                    "Tree planting creates future canopy cover, cooling the area for wildlife.",
                    "New trees will eventually provide nesting sites for birds and habitat for insects."
                ],
                "build_habitat": [
                    "You construct brush piles for small mammals and reptiles to shelter in.",
                    "Creating habitat structures provides hiding places for native wildlife.",
                    "Installing nest boxes attracts birds that help control insects."
                ],
                "test_water": [
                    "You test the water's pH and find it slightly acidic but within acceptable range.",
                    "Water testing reveals good oxygen levels but some sediment pollution.",
                    "The water quality is improving but still shows signs of upstream impacts."
                ],
                "continue_exploring": [
                    "You venture further and find areas that could be restored.",
                    "Exploring reveals issues that need addressing.",
                    "You discover beautiful areas that support native species."
                ],
                "check_wetland": [
                    "The wetland is thriving with native plants and aquatic insects.",
                    "You notice invasive species are starting to take over part of the wetland.",
                    "The wetland acts as a natural filter, improving water quality."
                ],
                "educational_program": [
                    "You organize a community workshop on native plants. Attendance is good!",
                    "Local students participate in a habitat restoration field day.",
                    "Your educational efforts raise awareness about ecosystem conservation."
                ],
                "fundraiser": [
                    "You host a fundraiser and attract support from local businesses.",
                    "Community members donate to support your conservation work.",
                    "Your fundraising efforts secure resources for future projects."
                ],
                "recruit_volunteers": [
                    "You post volunteer opportunities and several people sign up to help.",
                    "Local community groups offer to participate in restoration days.",
                    "Your volunteer recruitment brings new energy and resources to the project."
                ],
                "research_grants": [
                    "You apply for and receive a small research grant to study the ecosystem.",
                    "A university partner provides funding for monitoring equipment.",
                    "Your grant application is successful, providing funds for restoration."
                ],
                "enact_policy": [
                    "The new policy begins to take effect, with mixed reactions from the community.",
                    "Implementing this policy requires careful balancing of economic and environmental concerns.",
                    "Stakeholders respond to the new regulations, creating both challenges and opportunities."
                ],
                "climate_mitigation": [
                    "Your mitigation efforts help buffer the ecosystem from climate impacts.",
                    "Implementing climate-resilient practices strengthens the ecosystem's ability to adapt.",
                    "The habitat modifications provide refuge for species affected by changing conditions."
                ],
                "hire_npc": [
                    "You recruit a specialist to join your team. Their expertise will be valuable.",
                    "A new team member joins your conservation effort, bringing specialized skills.",
                    "Adding expertise to your team improves your effectiveness."
                ]
            };

            // Select a random response from the appropriate array
            const possibleResponses = responses[choice.id] || [
                "Your action has consequences for the ecosystem.",
                "The environment responds to your intervention.",
                "Nature adapts to your conservation efforts."
            ];
            
            // Add climate context if relevant
            let response = possibleResponses[Math.floor(Math.random() * possibleResponses.length)];
            
            if (temperature > 20 && choice.id.includes("plant")) {
                response += " The warm weather makes this work challenging - these plants will need extra water to establish.";
            }
            
            return response;
        };

        // More sophisticated ecosystem update function
        const updateEcosystem = (choice, ecosystemData, currentLocation) => {
            const updatedData = { ...ecosystemData };
            const locationData = locations[currentLocation];
            
            // Update based on action
            switch(choice.id) {
                case "plant_shrubs":
                    updatedData.shrubsPlanted += 1;
                    updatedData.ecosystemHealth += 5;
                    updatedData.biodiversityIndex += 3;
                    updatedData.carbonSequestration += 0.5;
                    updatedData.budget -= choice.cost;
                    break;
                case "plant_trees":
                    updatedData.treesPlanted += 1;
                    updatedData.ecosystemHealth += 8;
                    updatedData.biodiversityIndex += 5;
                    updatedData.carbonSequestration += 5;
                    updatedData.budget -= choice.cost;
                    break;
                case "remove_weeds":
                    updatedData.invasiveSpeciesRemoved += 1;
                    updatedData.ecosystemHealth += 3;
                    updatedData.biodiversityIndex += 2;
                    updatedData.budget -= choice.cost;
                    break;
                case "observe_wildlife":
                    // Random chance to discover new wildlife based on biodiversity
                    if (Math.random() < updatedData.biodiversityIndex / 100 && updatedData.wildlifeObserved.length < Object.keys(tasmaniaWildlife).length) {
                        const possibleNewSpecies = Object.keys(tasmaniaWildlife).filter(
                            species => !updatedData.wildlifeObserved.includes(species) && 
                            tasmaniaWildlife[species].habitat === locationData.biome
                        );
                        if (possibleNewSpecies.length > 0) {
                            const newSpecies = possibleNewSpecies[Math.floor(Math.random() * possibleNewSpecies.length)];
                            updatedData.wildlifeObserved.push(newSpecies);
                            updatedData.biodiversityIndex += 2;
                        }
                    }
                    updatedData.ecosystemHealth += 1;
                    break;
                case "explore":
                    // Explore new locations
                    const unexploredLocations = Object.keys(locations).filter(
                        loc => !updatedData.locationsVisited.includes(loc)
                    );
                    if (unexploredLocations.length > 0 && Math.random() > 0.7) {
                        const newLocation = unexploredLocations[Math.floor(Math.random() * unexploredLocations.length)];
                        updatedData.locationsVisited.push(newLocation);
                        updatedData.currentLocation = newLocation;
                    }
                    updatedData.ecosystemHealth += 1;
                    break;
                case "check_wetland":
                    if (!updatedData.locationsVisited.includes('macquarie_harbor')) {
                        updatedData.locationsVisited.push('macquarie_harbor');
                    }
                    if (!updatedData.wildlifeObserved.includes('platypus')) {
                        updatedData.wildlifeObserved.push('platypus');
                    }
                    updatedData.ecosystemHealth += 4;
                    updatedData.waterQuality += 3;
                    break;
                case "educational_program":
                    updatedData.educationLevel += 10;
                    updatedData.reputation += 5;
                    updatedData.budget -= choice.cost;
                    break;
                case "fundraiser":
                    updatedData.budget += 200 + Math.floor(Math.random() * 300);
                    updatedData.reputation += 3;
                    break;
                case "recruit_volunteers":
                    updatedData.volunteers += 2 + Math.floor(Math.random() * 4);
                    updatedData.reputation += 4;
                    updatedData.budget -= choice.cost;
                    break;
                case "research_grants":
                    updatedData.budget += 1000 + Math.floor(Math.random() * 1500);
                    updatedData.reputation += 8;
                    break;
                case "enact_policy":
                    const policy = policyOptions.find(p => p.id === choice.policyId);
                    if (policy) {
                        updatedData.policiesEnacted.push(choice.policyId);
                        updatedData.budget += policy.budgetImpact || 0;
                        updatedData.ecosystemHealth += policy.healthImpact || 0;
                        updatedData.biodiversityIndex += policy.biodiversityImpact || 0;
                        updatedData.waterQuality += policy.waterQualityImpact || 0;
                        updatedData.reputation += policy.reputationImpact || 0;
                        updatedData.co2Level += policy.co2Impact || 0;
                        if (policy.volunteerImpact) {
                            updatedData.volunteers += policy.volunteerImpact;
                        }
                    }
                    break;
                case "climate_mitigation":
                    updatedData.ecosystemHealth += 5;
                    updatedData.budget -= choice.cost;
                    // Reduce severity of next climate event
                    if (updatedData.climateEvents.length > 0) {
                        updatedData.climateEvents[0].severity = "low";
                    }
                    break;
                case "hire_npc":
                    const npc = npcTeamMembers.find(m => m.id === choice.npcId);
                    if (npc && !updatedData.npcTeam.some(m => m.id === choice.npcId)) {
                        updatedData.npcTeam.push(npc);
                        updatedData.budget -= choice.cost;
                    }
                    break;
                default:
                    updatedData.ecosystemHealth += 1;
            }
            
            // NPC team effects
            updatedData.npcTeam.forEach(npc => {
                // Each NPC provides a bonus to certain actions
                updatedData.ecosystemHealth += 0.5 * npc.efficiency;
                updatedData.biodiversityIndex += 0.3 * npc.efficiency;
            });
            
            // Update day and possibly season
            updatedData.day += choice.time || 1;
            if (updatedData.day % 30 === 0) {
                const seasons = ['spring', 'summer', 'fall', 'winter'];
                const currentSeasonIndex = seasons.indexOf(updatedData.season);
                updatedData.season = seasons[(currentSeasonIndex + 1) % 4];
                
                // Seasonal effects (adjusted for Tasmania's climate)
                if (updatedData.season === 'spring') {
                    updatedData.ecosystemHealth += 5; // Spring growth
                    updatedData.rainfall += 10; // Spring rains
                } else if (updatedData.season === 'summer') {
                    updatedData.temperature += 2; // Summer heat (milder in Tasmania)
                    updatedData.rainfall -= 5; // Summer is drier but not drought-like
                } else if (updatedData.season === 'fall') {
                    updatedData.temperature -= 2; // Cooling temperatures
                } else if (updatedData.season === 'winter') {
                    updatedData.temperature -= 3; // Winter cold
                    updatedData.rainfall += 5; // Winter rains
                }
            }
            
            // Climate change effects - gradual changes over time
            if (updatedData.day % 10 === 0) {
                updatedData.temperature += 0.1; // Gradual warming
                updatedData.co2Level += 0.5; // Increasing CO2
                
                // More extreme weather patterns
                if (Math.random() > 0.7) {
                    updatedData.rainfall += (Math.random() > 0.5 ? 5 : -5);
                }
            }
            
            // Random climate events
            if (Math.random() < 0.15 && updatedData.day > 10) {
                const event = {...climateEvents[Math.floor(Math.random() * climateEvents.length)]};
                updatedData.climateEvents.unshift({
                    ...event,
                    day: updatedData.day,
                    active: true
                });
                
                // Apply event effects
                updatedData.ecosystemHealth += event.healthImpact || 0;
                updatedData.waterQuality += event.waterQualityImpact || 0;
                updatedData.biodiversityIndex += event.biodiversityImpact || 0;
                updatedData.temperature += event.temperatureImpact || 0;
                updatedData.budget += event.budgetImpact || 0;
            }
            
            // Natural processes - ecosystem changes over time
            if (updatedData.ecosystemHealth > 70) {
                updatedData.biodiversityIndex += 1; // Healthy ecosystems become more diverse
            }
            
            if (updatedData.waterQuality < 50 && updatedData.day % 5 === 0) {
                updatedData.ecosystemHealth -= 1; // Poor water quality has ongoing effects
            }
            
            // Volunteer effects
            if (updatedData.volunteers > 0) {
                updatedData.ecosystemHealth += Math.floor(updatedData.volunteers / 5);
            }
            
            // Policy effects
            updatedData.policiesEnacted.forEach(policyId => {
                const policy = policyOptions.find(p => p.id === policyId);
                if (policy) {
                    // Ongoing effects of policies
                    updatedData.co2Level += (policy.co2Impact || 0) / 10;
                }
            });
            
            // Cap values
            updatedData.ecosystemHealth = Math.min(Math.max(updatedData.ecosystemHealth, 0), 100);
            updatedData.biodiversityIndex = Math.min(Math.max(updatedData.biodiversityIndex, 0), 100);
            updatedData.waterQuality = Math.min(Math.max(updatedData.waterQuality, 0), 100);
            updatedData.temperature = Math.min(Math.max(updatedData.temperature, -5), 35); // Tasmania has milder temps
            updatedData.rainfall = Math.min(Math.max(updatedData.rainfall, 0), 200);
            
            // Add to historical data
            updatedData.historicalData.push({
                day: updatedData.day,
                health: updatedData.ecosystemHealth,
                biodiversity: updatedData.biodiversityIndex,
                waterQuality: updatedData.waterQuality,
                temperature: updatedData.temperature,
                co2Level: updatedData.co2Level
            });
            
            return updatedData;
        };

        // More dynamic choice generation
        const getNextChoices = (ecosystemData, currentLocation) => {
            const { ecosystemHealth, biodiversityIndex, budget, reputation, educationLevel, volunteers, locationsVisited, policiesEnacted, climateEvents, npcTeam } = ecosystemData;
            
            const baseChoices = [
                { id: "observe_wildlife", text: "Observe wildlife", cost: 0, time: 1 },
                { id: "explore", text: "Explore new areas", cost: 0, time: 1 }
            ];
            
            const specialChoices = [];
            
            // Restoration actions
            if (budget >= 50) {
                specialChoices.push({ id: "plant_shrubs", text: "Plant native shrubs", cost: 50, time: 1 });
            }
            
            if (budget >= 20) {
                specialChoices.push({ id: "remove_weeds", text: "Remove invasive species", cost: 20, time: 1 });
            }
            
            if (locationsVisited.includes('cradle_mountain') && budget >= 100) {
                specialChoices.push({ id: "plant_trees", text: "Plant trees", cost: 100, time: 2 });
            }
            
            if (locationsVisited.includes('macquarie_harbor')) {
                specialChoices.push({ id: "check_wetland", text: "Monitor wetland health", cost: 0, time: 1 });
            }
            
            if (ecosystemHealth > 70 && budget >= 150) {
                specialChoices.push({ id: "build_habitat", text: "Build habitat structures", cost: 150, time: 2 });
            }
            
            if (ecosystemHealth > 60 && budget >= 80) {
                specialChoices.push({ id: "test_water", text: "Conduct water quality tests", cost: 80, time: 1 });
            }
            
            // Community engagement actions
            if (reputation >= 30 && budget >= 100) {
                specialChoices.push({ id: "educational_program", text: "Run educational program", cost: 100, time: 2 });
            }
            
            if (reputation >= 20) {
                specialChoices.push({ id: "fundraiser", text: "Organize fundraiser", cost: 50, time: 2 });
            }
            
            if (reputation >= 40) {
                specialChoices.push({ id: "recruit_volunteers", text: "Recruit volunteers", cost: 30, time: 1 });
            }
            
            if (educationLevel >= 50 && reputation >= 60) {
                specialChoices.push({ id: "research_grants", text: "Apply for research grants", cost: 100, time: 3 });
            }
            
            // Policy options (only show if not already enacted)
            policyOptions.forEach(policy => {
                if (!policiesEnacted.includes(policy.id) && budget >= Math.abs(policy.cost) && reputation >= 40) {
                    specialChoices.push({ 
                        id: "enact_policy", 
                        text: `Enact: ${policy.name}`, 
                        cost: policy.cost, 
                        time: 3,
                        policyId: policy.id
                    });
                }
            });
            
            // NPC hiring options
            if (ecosystemData.gameMode === 'team') {
                npcTeamMembers.forEach(npc => {
                    if (!npcTeam.some(m => m.id === npc.id) && budget >= npc.cost) {
                        specialChoices.push({
                            id: "hire_npc",
                            text: `Hire: ${npc.name} (${npc.role})`,
                            cost: npc.cost,
                            time: 2,
                            npcId: npc.id
                        });
                    }
                });
            }
            
            // Climate mitigation options
            if (climateEvents.length > 0 && climateEvents[0].active && budget >= 200) {
                specialChoices.push({ 
                    id: "climate_mitigation", 
                    text: `Mitigate: ${climateEvents[0].name}`, 
                    cost: 200, 
                    time: 2 
                });
            }
            
            // Always include "End Adventure" once significant progress is made
            if (ecosystemHealth > 40 || biodiversityIndex > 35) {
                specialChoices.push({ id: "end_adventure", text: "End Adventure", cost: 0, time: 0 });
            }
            
            // Return 3-5 choices
            const allChoices = [...new Set([...specialChoices, ...baseChoices])];
            return allChoices.slice(0, 5);
        };

        // Map component for location visualization
        const LocationMap = ({ locationKey }) => {
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const markerRef = useRef(null);
            
            useEffect(() => {
                if (mapRef.current && locations[locationKey]) {
                    const location = locations[locationKey];
                    
                    // Initialize map if not already exists
                    if (!mapInstance.current) {
                        mapInstance.current = L.map(mapRef.current).setView(location.coordinates, 10);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(mapInstance.current);
                        
                        // Add Tasmania outline
                        L.polygon([
                            [-40.68, 144.72],
                            [-40.68, 148.25],
                            [-43.63, 148.25],
                            [-43.63, 144.72]
                        ], {color: '#3388ff', weight: 2, fill: false}).addTo(mapInstance.current);
                    } else {
                        mapInstance.current.setView(location.coordinates, 10);
                    }
                    
                    // Remove existing marker if any
                    if (markerRef.current) {
                        mapInstance.current.removeLayer(markerRef.current);
                    }
                    
                    // Add new marker
                    markerRef.current = L.marker(location.coordinates)
                        .addTo(mapInstance.current)
                        .bindPopup(`<b>${location.name}</b><br>${location.description}`)
                        .openPopup();
                }
                
                return () => {
                    if (mapInstance.current) {
                        mapInstance.current.remove();
                        mapInstance.current = null;
                    }
                };
            }, [locationKey]);
            
            return <div id="map" ref={mapRef} />;
        };

        // Chart component for data visualization
        const EcosystemChart = ({ data }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            
            useEffect(() => {
                if (chartRef.current) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    // Destroy previous chart if it exists
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                    
                    // Create new chart
                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(d => `Day ${d.day}`),
                            datasets: [
                                {
                                    label: 'Ecosystem Health',
                                    data: data.map(d => d.health),
                                    borderColor: 'rgb(75, 192, 192)',
                                    tension: 0.1,
                                    fill: false
                                },
                                {
                                    label: 'Biodiversity Index',
                                    data: data.map(d => d.biodiversity),
                                    borderColor: 'rgb(153, 102, 255)',
                                    tension: 0.1,
                                    fill: false
                                },
                                {
                                    label: 'Water Quality',
                                    data: data.map(d => d.waterQuality),
                                    borderColor: 'rgb(54, 162, 235)',
                                    tension: 0.1,
                                    fill: false
                                },
                                {
                                    label: 'Temperature (¬∞C)',
                                    data: data.map(d => d.temperature),
                                    borderColor: 'rgb(255, 99, 132)',
                                    tension: 0.1,
                                    fill: false,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Ecosystem Metrics Over Time'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: 'Percentage'
                                    }
                                },
                                y1: {
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'Temperature (¬∞C)'
                                    },
                                    grid: {
                                        drawOnChartArea: false
                                    }
                                }
                            }
                        }
                    });
                }
                
                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data]);
            
            return <canvas ref={chartRef} />;
        };

        // Climate chart component
        const ClimateChart = ({ data }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            
            useEffect(() => {
                if (chartRef.current) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    // Destroy previous chart if it exists
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                    
                    // Create new chart
                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(d => `Day ${d.day}`),
                            datasets: [
                                {
                                    label: 'Temperature (¬∞C)',
                                    data: data.map(d => d.temperature),
                                    borderColor: 'rgb(255, 99, 132)',
                                    tension: 0.1,
                                    fill: false
                                },
                                {
                                    label: 'CO2 Level (ppm)',
                                    data: data.map(d => d.co2Level),
                                    borderColor: 'rgb(100, 100, 100)',
                                    tension: 0.1,
                                    fill: false,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Climate Metrics Over Time'
                                }
                            },
                            scales: {
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Temperature (¬∞C)'
                                    }
                                },
                                y1: {
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'CO2 (ppm)'
                                    },
                                    grid: {
                                        drawOnChartArea: false
                                    }
                                }
                            }
                        }
                    });
                }
                
                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data]);
            
            return <canvas ref={chartRef} />;
        };

        // Main component
        function EcoQuest() {
            const [gameStarted, setGameStarted] = useState(false);
            const [gameModeSelected, setGameModeSelected] = useState(false);
            const [gameCompleted, setGameCompleted] = useState(false);
            const [storyLog, setStoryLog] = useState(initialStoryLog);
            const [ecosystemData, setEcosystemData] = useState(initialEcosystemData);
            const [currentChoices, setCurrentChoices] = useState(initialChoices);
            const [currentLocation, setCurrentLocation] = useState('tarkine_forest');
            const [showCharts, setShowCharts] = useState(false);
            const [showClimateChart, setShowClimateChart] = useState(false);
            const [weatherData, setWeatherData] = useState(null);

            // Function to fetch Tasmania weather data (simulated)
            const fetchWeatherData = async (coordinates) => {
                // Simulated Tasmania weather data
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const baseTemp = 8 + (Math.random() * 12); // 8-20¬∞C typical for Tasmania
                        const rainfall = 30 + (Math.random() * 70); // 30-100mm common in Tasmania
                        resolve({
                            temperature: Math.round(baseTemp * 10) / 10,
                            rainfall: Math.round(rainfall * 10) / 10,
                            conditions: rainfall > 70 ? "rainy" : rainfall > 40 ? "cloudy" : "sunny"
                        });
                    }, 500);
                });
            };

            useEffect(() => {
                // Fetch weather data when location changes
                const fetchData = async () => {
                    const data = await fetchWeatherData(locations[currentLocation].coordinates);
                    setWeatherData(data);
                };
                
                if (gameStarted && !gameCompleted) {
                    fetchData();
                }
            }, [currentLocation, gameStarted, gameCompleted]);

            const handleChoice = (choice) => {
                if (choice.id === "end_adventure") {
                    setGameCompleted(true);
                    return;
                }
                
                // Generate AI response
                const response = generateAIResponse(choice, ecosystemData, currentLocation);
                
                // Update ecosystem data
                const updatedEcosystem = updateEcosystem(choice, ecosystemData, currentLocation);
                setEcosystemData(updatedEcosystem);
                
                // Update story log
                setStoryLog(prevLog => [...prevLog, `> ${choice.text}`, response]);
                
                // Determine next choices
                const nextChoices = getNextChoices(updatedEcosystem, currentLocation);
                setCurrentChoices(nextChoices);
                
                // Possibly change location based on exploration
                if (choice.id === "explore" && updatedEcosystem.locationsVisited.length > ecosystemData.locationsVisited.length) {
                    const newLocation = updatedEcosystem.locationsVisited[updatedEcosystem.locationsVisited.length - 1];
                    setCurrentLocation(newLocation);
                    setStoryLog(prevLog => [...prevLog, `You've discovered a new area: ${locations[newLocation].name}!`]);
                }
            };

            const startGame = (mode) => {
                setEcosystemData(prev => ({
                    ...prev,
                    gameMode: mode
                }));
                setGameModeSelected(true);
                setGameStarted(true);
            };

            const restartGame = () => {
                setGameStarted(false);
                setGameModeSelected(false);
                setGameCompleted(false);
                setStoryLog(initialStoryLog);
                setEcosystemData(initialEcosystemData);
                setCurrentChoices(initialChoices);
                setCurrentLocation('tarkine_forest');
                setWeatherData(null);
            };

            // Auto-scroll to bottom of story panel
            const storyPanelRef = useRef(null);
            useEffect(() => {
                if (storyPanelRef.current) {
                    storyPanelRef.current.scrollTop = storyPanelRef.current.scrollHeight;
                }
            }, [storyLog]);

            return (
                <div className="min-h-screen p-4 md:p-6">
                    {!gameModeSelected ? (
                        // Game Mode Selection Page
                        <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8 mt-10 text-center fade-in">
                            <h1 className="text-4xl font-bold text-green-800 mb-4">üå± EcoQuest: Tasmania</h1>
                            <h2 className="text-2xl font-semibold text-green-700 mb-6">Choose Your Adventure Mode</h2>
                            <p className="text-gray-600 mb-8 text-lg">
                                Explore Tasmania's unique ecosystems and work to protect its endangered species.
                            </p>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                <div 
                                    className="border-2 border-green-200 rounded-xl p-6 cursor-pointer hover:bg-green-50 transition-colors"
                                    onClick={() => startGame('solo')}
                                >
                                    <div className="text-4xl mb-4">üë§</div>
                                    <h3 className="text-xl font-semibold text-green-700 mb-2">Solo Explorer</h3>
                                    <p className="text-gray-600">Work alone to restore Tasmania's ecosystems at your own pace.</p>
                                    <ul className="text-left text-gray-600 mt-4 space-y-2 text-sm">
                                        <li className="flex items-start">
                                            <span className="text-green-500 mr-2">‚Ä¢</span>
                                            <span>More focused decision-making</span>
                                        </li>
                                        <li className="flex items-start">
                                            <span className="text-green-500 mr-2">‚Ä¢</span>
                                            <span>Complete control over strategies</span>
                                        </li>
                                        <li className="flex items-start">
                                            <span className="text-green-500 mr-2">‚Ä¢</span>
                                            <span>Slower progress but full autonomy</span>
                                        </li>
                                    </ul>
                                </div>
                                
                                <div 
                                    className="border-2 border-blue-200 rounded-xl p-6 cursor-pointer hover:bg-blue-50 transition-colors"
                                    onClick={() => startGame('team')}
                                >
                                    <div className="text-4xl mb-4">üë•</div>
                                    <h3 className="text-xl font-semibold text-blue-700 mb-2">Team Leader</h3>
                                    <p className="text-gray-600">Build a team of specialists to tackle complex conservation challenges.</p>
                                    <ul className="text-left text-gray-600 mt-4 space-y-2 text-sm">
                                        <li className="flex items-start">
                                            <span className="text-blue-500 mr-2">‚Ä¢</span>
                                            <span>Hire NPC specialists with unique skills</span>
                                        </li>
                                        <li className="flex items-start">
                                            <span className="text-blue-500 mr-2">‚Ä¢</span>
                                            <span>Faster progress with team bonuses</span>
                                        </li>
                                        <li className="flex items-start">
                                            <span className="text-blue-500 mr-2">‚Ä¢</span>
                                            <span>More complex management required</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div className="border-t pt-6">
                                <h3 className="text-lg font-medium text-green-700 mb-3">Tasmanian Regions</h3>
                                <div className="flex flex-wrap justify-center gap-2">
                                    {Object.values(locations).map((location, idx) => (
                                        <span key={idx} className="bg-green-100 text-green-800 text-sm px-3 py-1 rounded-full">
                                            {location.name}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        </div>
                    ) : !gameStarted ? (
                        // Landing Page
                        <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8 mt-10 text-center fade-in">
                            <h1 className="text-4xl font-bold text-green-800 mb-4">üå± EcoQuest: Tasmania</h1>
                            <h2 className="text-2xl font-semibold text-green-700 mb-6">Interactive Ecosystem Management</h2>
                            <p className="text-gray-600 mb-8 text-lg">
                                Embark on an interactive conservation adventure where your choices shape Tasmania's unique ecosystems. 
                                Restore balance to threatened landscapes and protect endangered species.
                            </p>
                            <button 
                                onClick={() => setGameStarted(true)}
                                className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full text-lg transition duration-300 transform hover:scale-105 btn-hover pulse-animation"
                            >
                                Start Adventure
                            </button>
                            
                            <div className="mt-10 border-t pt-6">
                                <h3 className="text-lg font-medium text-green-700 mb-3">How to Play</h3>
                                <ul className="text-left text-gray-600 space-y-2 max-w-md mx-auto">
                                    <li className="flex items-start">
                                        <span className="text-green-500 mr-2">‚Ä¢</span>
                                        <span>Make strategic choices to restore ecosystems</span>
                                    </li>
                                    <li className="flex items-start">
                                        <span className="text-green-500 mr-2">‚Ä¢</span>
                                        <span>Manage limited resources and budget effectively</span>
                                    </li>
                                    <li className="flex items-start">
                                        <span className="text-green-500 mr-2">‚Ä¢</span>
                                        <span>Track multiple environmental metrics over time</span>
                                    </li>
                                    <li className="flex items-start">
                                        <span className="text-green-500 mr-2">‚Ä¢</span>
                                        <span>Discover Tasmania's unique locations and wildlife</span>
                                    </li>
                                    <li className="flex items-start">
                                        <span className="text-green-500 mr-2">‚Ä¢</span>
                                        <span>{ecosystemData.gameMode === 'team' ? 'Build and manage your conservation team' : 'Work solo to restore ecosystems'}</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    ) : gameCompleted ? (
                        // Game Completion Screen
                        <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8 mt-10 text-center fade-in">
                            <h1 className="text-4xl font-bold text-green-800 mb-4">üèÜ Adventure Complete!</h1>
                            <h2 className="text-2xl font-semibold text-green-700 mb-6">Your Conservation Results</h2>
                            
                            <div className="mb-6 p-4 bg-green-50 rounded-lg">
                                <h3 className="text-lg font-medium text-green-700 mb-2">Final Ecosystem Health: {ecosystemData.ecosystemHealth}%</h3>
                                <div className="w-full bg-gray-200 rounded-full h-4 mb-4">
                                    <div 
                                        className="bg-green-600 h-4 rounded-full transition-all duration-500 health-bar" 
                                        style={{ width: `${ecosystemData.ecosystemHealth}%` }}
                                    ></div>
                                </div>
                                
                                <div className="grid grid-cols-2 gap-4 text-left">
                                    <div>
                                        <p className="font-medium">Biodiversity Index</p>
                                        <p>{ecosystemData.biodiversityIndex}%</p>
                                    </div>
                                    <div>
                                        <p className="font-medium">Water Quality</p>
                                        <p>{ecosystemData.waterQuality}%</p>
                                    </div>
                                    <div>
                                        <p className="font-medium">Carbon Sequestered</p>
                                        <p>{ecosystemData.carbonSequestration.toFixed(1)} tons</p>
                                    </div>
                                    <div>
                                        <p className="font-medium">Species Observed</p>
                                        <p>{ecosystemData.wildlifeObserved.length}</p>
                                    </div>
                                    <div>
                                        <p className="font-medium">Temperature Change</p>
                                        <p>+{(ecosystemData.temperature - 12).toFixed(1)}¬∞C</p>
                                    </div>
                                    <div>
                                        <p className="font-medium">CO2 Level</p>
                                        <p>{ecosystemData.co2Level.toFixed(1)} ppm</p>
                                    </div>
                                </div>
                            </div>
                            
                            <button 
                                onClick={restartGame}
                                className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full text-lg transition duration-300 transform hover:scale-105 btn-hover mt-4"
                            >
                                Play Again
                            </button>
                            
                            <div className="mt-6 space-y-4">
                                <button 
                                    onClick={() => setShowCharts(!showCharts)}
                                    className="text-green-600 hover:text-green-800 font-medium mx-2"
                                >
                                    {showCharts ? 'Hide' : 'Show'} Progress Charts
                                </button>
                                
                                <button 
                                    onClick={() => setShowClimateChart(!showClimateChart)}
                                    className="text-green-600 hover:text-green-800 font-medium mx-2"
                                >
                                    {showClimateChart ? 'Hide' : 'Show'} Climate Charts
                                </button>
                                
                                {showCharts && (
                                    <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                                        <EcosystemChart data={ecosystemData.historicalData} />
                                    </div>
                                )}
                                
                                {showClimateChart && (
                                    <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                                        <ClimateChart data={ecosystemData.historicalData} />
                                    </div>
                                )}
                            </div>
                        </div>
                    ) : (
                        // Game Interface
                        <div className="max-w-7xl mx-auto fade-in">
                            <header className="flex justify-between items-center mb-6">
                                <div>
                                    <h1 className="text-3xl font-bold text-green-800 flex items-center">
                                        <span className="mr-2">üåø</span> EcoQuest: Tasmania
                                    </h1>
                                    <p className="text-green-600">
                                        {ecosystemData.gameMode === 'solo' ? 'Solo Explorer' : 'Team Leader'} Mode
                                    </p>
                                </div>
                                <div className="flex items-center space-x-4">
                                    <div className="bg-white rounded-lg py-1 px-3 shadow-sm">
                                        <span className="text-green-700 font-medium">Day {ecosystemData.day}</span>
                                        <span className="mx-2">‚Ä¢</span>
                                        <span className="text-green-600 capitalize">{ecosystemData.season}</span>
                                    </div>
                                    <button 
                                        onClick={() => setShowCharts(!showCharts)}
                                        className="bg-white hover:bg-gray-100 text-gray-800 font-medium py-2 px-4 rounded-lg transition btn-hover flex items-center"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                            <path fillRule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                                        </svg>
                                        {showCharts ? 'Hide Charts' : 'Show Charts'}
                                    </button>
                                    <button 
                                        onClick={restartGame}
                                        className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition btn-hover flex items-center"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                            <path fillRule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clipRule="evenodd" />
                                        </svg>
                                        Restart
                                    </button>
                                </div>
                            </header>
                            
                            {showCharts && (
                                <div className="mb-6 bg-white rounded-xl shadow-md p-4">
                                    <EcosystemChart data={ecosystemData.historicalData} />
                                </div>
                            )}
                            
                            <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                                {/* Story Panel */}
                                <div className="lg:col-span-2 bg-white rounded-xl shadow-md p-6">
                                    <h2 className="text-xl font-semibold text-green-700 mb-4 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clipRule="evenodd" />
                                        </svg>
                                        Your Adventure at {locations[currentLocation].name}
                                    </h2>
                                    
                                    {/* Location Map */}
                                    <div className="mb-4">
                                        <LocationMap locationKey={currentLocation} />
                                    </div>
                                    
                                    {/* Weather Data */}
                                    {weatherData && (
                                        <div className="flex items-center justify-around mb-4 p-3 bg-blue-50 rounded-lg">
                                            <div className="text-center">
                                                <span className="block text-xl font-bold">{weatherData.temperature}¬∞C</span>
                                                <span className="text-sm text-gray-600">Temperature</span>
                                            </div>
                                            <div className="text-center">
                                                <span className="block text-xl font-bold">{weatherData.rainfall}mm</span>
                                                <span className="text-sm text-gray-600">Rainfall</span>
                                            </div>
                                            <div className="text-center">
                                                <span className="block text-xl font-bold capitalize">{weatherData.conditions}</span>
                                                <span className="text-sm text-gray-600">Conditions</span>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div 
                                        ref={storyPanelRef}
                                        className="h-96 overflow-y-auto mb-4 p-4 bg-green-50 rounded-lg border border-green-200"
                                    >
                                        {storyLog.map((msg, idx) => (
                                            <p key={idx} className="mb-3 text-gray-700 story-text">{msg}</p>
                                        ))}
                                    </div>
                                    
                                    {/* Climate Events */}
                                    {ecosystemData.climateEvents.length > 0 && ecosystemData.climateEvents[0].active && (
                                        <div className="mb-4 p-4 bg-red-100 rounded-lg border border-red-300 climate-event">
                                            <h3 className="font-bold text-red-800 flex items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                                </svg>
                                                Climate Event: {ecosystemData.climateEvents[0].name}
                                            </h3>
                                            <p className="text-red-700">{ecosystemData.climateEvents[0].effect}</p>
                                        </div>
                                    )}
                                    
                                    {/* Choice Buttons */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
                                        {currentChoices.map((choice, idx) => (
                                            <button
                                                key={idx}
                                                onClick={() => handleChoice(choice)}
                                                disabled={ecosystemData.budget < choice.cost}
                                                className={`${ecosystemData.budget < choice.cost ? 
                                                    'bg-gray-300 cursor-not-allowed' : 
                                                    'bg-green-500 hover:bg-green-600'} 
                                                    text-white font-medium py-3 px-4 rounded-lg transition duration-300 transform hover:scale-105 btn-hover flex items-center justify-center`}
                                            >
                                                {choice.cost > 0 && (
                                                    <span className="mr-2 bg-green-700 rounded-full px-2 py-1 text-xs">
                                                        ${choice.cost}
                                                    </span>
                                                )}
                                                {choice.text}
                                                {choice.time > 1 && (
                                                    <span className="ml-2 bg-green-700 rounded-full px-2 py-1 text-xs">
                                                        {choice.time}d
                                                    </span>
                                                )}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* Stats Panel */}
                                <div className="bg-white rounded-xl shadow-md p-6">
                                    <h2 className="text-xl font-semibold text-green-700 mb-4 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                            <path fillRule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.22l.123.489.804.804A1 1 0 0113 18H7a1 1 0 01-.707-1.707l.804-.804L7.22 15H5a2 2 0 01-2-2V5zm5.771 7H5V5h10v7H8.771z" clipRule="evenodd" />
                                        </svg>
                                        Ecosystem Dashboard
                                    </h2>
                                    
                                    <div className="mb-6">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-gray-600">Overall Health</span>
                                            <span className="font-semibold">{ecosystemData.ecosystemHealth}%</span>
                                        </div>
                                        <div className="w-full bg-gray-200 rounded-full h-4 mb-4">
                                            <div 
                                                className="bg-green-600 h-4 rounded-full transition-all duration-500 health-bar" 
                                                style={{ width: `${ecosystemData.ecosystemHealth}%` }}
                                            ></div>
                                        </div>
                                        
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-gray-600">Biodiversity</span>
                                            <span className="font-semibold">{ecosystemData.biodiversityIndex}%</span>
                                        </div>
                                        <div className="w-full bg-gray-200 rounded-full h-4 mb-4">
                                            <div 
                                                className="bg-purple-500 h-4 rounded-full transition-all duration-500 health-bar" 
                                                style={{ width: `${ecosystemData.biodiversityIndex}%` }}
                                            ></div>
                                        </div>
                                        
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-gray-600">Water Quality</span>
                                            <span className="font-semibold">{ecosystemData.waterQuality}%</span>
                                        </div>
                                        <div className="w-full bg-gray-200 rounded-full h-4 mb-4">
                                            <div 
                                                className="bg-blue-500 h-4 rounded-full transition-all duration-500 health-bar" 
                                                style={{ width: `${ecosystemData.waterQuality}%` }}
                                            ></div>
                                        </div>
                                        
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-gray-600">Temperature</span>
                                            <span className="font-semibold">{ecosystemData.temperature.toFixed(1)}¬∞C</span>
                                        </div>
                                        <div className="w-full bg-gray-200 rounded-full h-4 mb-4">
                                            <div 
                                                className="bg-red-500 h-4 rounded-full transition-all duration-500 health-bar" 
                                                style={{ width: `${((ecosystemData.temperature + 5) / 40) * 100}%` }}
                                            ></div>
                                        </div>
                                        
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-gray-600">CO2 Level</span>
                                            <span className="font-semibold">{ecosystemData.co2Level.toFixed(1)} ppm</span>
                                        </div>
                                        <div className="w-full bg-gray-200 rounded-full h-4">
                                            <div 
                                                className="bg-gray-600 h-4 rounded-full transition-all duration-500 health-bar" 
                                                style={{ width: `${((ecosystemData.co2Level - 300) / 200) * 100}%` }}
                                            ></div>
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        <div>
                                            <h3 className="text-lg font-medium text-green-700 mb-2 flex items-center justify-between">
                                                <span>Resources</span>
                                                <span className="text-lg font-bold text-green-600">${ecosystemData.budget}</span>
                                            </h3>
                                            <ul className="space-y-2">
                                                <li className="flex justify-between">
                                                    <span className="flex items-center">
                                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-2 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fillRule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clipRule="evenodd" />
                                                        </svg>
                                                        Shrubs Planted
                                                    </span>
                                                    <span className="font-semibold">{ecosystemData.shrubsPlanted}</span>
                                                </li>
                                                <li className="flex justify-between">
                                                    <span className="flex items-center">
                                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-2 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fillRule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clipRule="evenodd" />
                                                        </svg>
                                                        Trees Planted
                                                    </span>
                                                    <span className="font-semibold">{ecosystemData.treesPlanted}</span>
                                                </li>
                                                <li className="flex justify-between">
                                                    <span className="flex items-center">
                                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-2 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fillRule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clipRule="evenodd" />
                                                        </svg>
                                                        Invasives Removed
                                                    </span>
                                                    <span className="font-semibold">{ecosystemData.invasiveSpeciesRemoved}</span>
                                                </li>
                                                <li className="flex justify-between">
                                                    <span className="flex items-center">
                                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-2 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd" />
                                                        </svg>
                                                        Volunteers
                                                    </span>
                                                    <span className="font-semibold">{ecosystemData.volunteers}</span>
                                                </li>
                                            </ul>
                                        </div>
                                        
                                        <div>
                                            <h3 className="text-lg font-medium text-green-700 mb-2 flex items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" />
                                                </svg>
                                                Wildlife Observed
                                            </h3>
                                            <div className="flex flex-wrap gap-2">
                                                {ecosystemData.wildlifeObserved.length > 0 ? (
                                                    ecosystemData.wildlifeObserved.map((animal, idx) => (
                                                        <span key={idx} className="bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full wildlife-item flex items-center">
                                                            <span className="mr-1">{tasmaniaWildlife[animal]?.image || 'üêæ'}</span>
                                                            {tasmaniaWildlife[animal]?.name || animal}
                                                        </span>
                                                    ))
                                                ) : (
                                                    <p className="text-gray-500">No wildlife observed yet</p>
                                                )}
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <h3 className="text-lg font-medium text-green-700 mb-2 flex items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fillRule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clipRule="evenodd" />
                                                </svg>
                                                Locations Discovered
                                            </h3>
                                            <div className="flex flex-wrap gap-2">
                                                {ecosystemData.locationsVisited.map((location, idx) => (
                                                    <span key={idx} className="bg-yellow-100 text-yellow-800 text-sm px-3 py-1 rounded-full flex items-center">
                                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fillRule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clipRule="evenodd" />
                                                        </svg>
                                                        {locations[location]?.name || location.replace('_', ' ')}
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                        
                                        {ecosystemData.gameMode === 'team' && (
                                            <div>
                                                <h3 className="text-lg font-medium text-green-700 mb-2 flex items-center">
                                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" />
                                                    </svg>
                                                    Your Team
                                                </h3>
                                                <div className="space-y-2">
                                                    {ecosystemData.npcTeam.length > 0 ? (
                                                        ecosystemData.npcTeam.map((npc, idx) => (
                                                            <div key={idx} className="flex items-center justify-between bg-green-50 p-2 rounded">
                                                                <div className="flex items-center">
                                                                    <span className="text-2xl mr-2">{npc.portrait}</span>
                                                                    <div>
                                                                        <div className="font-medium">{npc.name}</div>
                                                                        <div className="text-sm text-gray-600">{npc.role}</div>
                                                                    </div>
                                                                </div>
                                                                <span className="text-sm bg-green-200 text-green-800 px-2 py-1 rounded-full">
                                                                    +{npc.efficiency}x efficiency
                                                                </span>
                                                            </div>
                                                        ))
                                                    ) : (
                                                        <p className="text-gray-500">No team members yet. Hire specialists to help your efforts.</p>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EcoQuest />);
    </script>
</body>
</html>
